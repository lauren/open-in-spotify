(function(exports){var searchForArtist=function(artistName,successCallback){var spotifyUrl="http://ws.spotify.com/search/1/artist.json?q="+artistName.replace(/\s/g,"%20");querySpotify(spotifyUrl,successCallback)},searchForTrack=function(trackName,successCallback){var spotifyUrl="http://ws.spotify.com/search/1/track.json?q="+trackName.replace(/\s/g,"%20");querySpotify(spotifyUrl,successCallback)},querySpotify=function(spotifyUrl,callback){ajaxRequest(spotifyUrl,callback,function(error){throw"Can't connect to Spotify."})},validateTrackArtist=function(tracks,artist){return tracks.filter(function(thisTrack){return indexOfArtistName(thisTrack.artists,artist)>-1})},dedupeTracks=function(tracks){tracks=sanitizeTrackAndAlbumNames(tracks.reverse());var dedupedTracks=tracks.filter(function(thisTrack,index){var otherTracks=tracks.slice(index+1,tracks.length);return!findTrackInArray(thisTrack,otherTracks)});return dedupedTracks.reverse()},sanitizeTrackAndAlbumNames=function(tracks){return tracks.map(function(thisTrack){return thisTrack.name=thisTrack.name.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,""),thisTrack.name=thisTrack.name.replace(/\s{2,}/g," "),thisTrack.album.name=thisTrack.album.name.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,""),thisTrack.album.name=thisTrack.album.name.replace(/\s{2,}/g," "),thisTrack})},findTrackInArray=function(track,otherTracks){for(var i=0;i<otherTracks.length;i++)if(track.name===otherTracks[i].name&&track.album.name===otherTracks[i].album.name)return!0;return!1},indexOfArtistName=function(array,artistName){for(var i=0;i<array.length;i++)if(array[i].name.toLowerCase()===artistName.toLowerCase())return i;return-1},spotifyQuerier={ajaxRequest:function(url,successCallback,errorCallback){var xhr=new XMLHttpRequest;xhr.onload=successCallback,xhr.onerror=errorCallback,xhr.open("get",url),xhr.send()},getTracks:function(track,artist,callback){searchForTrack(track,function(){var response=JSON.parse(this.responseText),validTracks=validateTrackArtist(response.tracks,artist),tracks=dedupeTracks(validTracks);callback(tracks)})},getArtists:function(artist,callback){searchForArtist(artist,function(){var response=JSON.parse(this.responseText),artists=response.artists;callback(artists)})}};exports.spotifyQuerier=spotifyQuerier})(typeof exports=="undefined"?this:exports),function(exports){var render={showTrackOptions:function(tracks){var modalContent=addModal("large"),modalHeader=document.createElement("h2"),trackList=document.createElement("ul");modalHeader.innerHTML="Matching Tracks on Spotify",modalContent.appendChild(modalHeader),tracks.map(function(track){var trackItemEl=document.createElement("li"),firstArtist=track.artists[0];trackItemEl.innerHTML="<a href='"+track.href+"'>"+track.name+"</a> by <a href='"+firstArtist.href+"'>"+firstArtist.name+"</a> from the album "+"<em><a href='"+track.album.href+"'></em>"+track.album.name+"</a>.",trackList.appendChild(trackItemEl)}),modalContent.appendChild(trackList),this.pauseSourceSiteMusic()},showArtistOptions:function(artists){var modalContent=addModal("large"),modalHeader=document.createElement("h2"),modalCaveat=document.createElement("h3"),artistList=document.createElement("ul");modalCaveat.innerHTML="<p>Sorry! I couldn't find the exact track you're listening to on Spotify.</p>",modalContent.appendChild(modalCaveat),modalHeader.innerHTML="Matching Artists on Spotify",modalContent.appendChild(modalHeader),artists.map(function(artist){var artistItemEl=document.createElement("li");artistItemEl.innerHTML="<a href='"+artist.href+"'>"+artist.name+"</a>",artistList.appendChild(artistItemEl)}),modalContent.appendChild(artistList),this.pauseSourceSiteMusic()},showNotFoundMessage:function(){var modalContent=addModal("small"),modalHeader=document.createElement("h2"),modalExplanation=document.createElement("h3");modalHeader.innerHTML="Not Found",modalContent.appendChild(modalHeader),modalExplanation.innerHTML="<p>Sorry, I couldn't find the track '"+sourceSiteData.track+"' or the artist "+sourceSiteData.artist+" on Spotify.</p><p>Try again with the next song you like.</p>",modalContent.appendChild(modalExplanation)},showUnsupportedSiteMessage:function(){var modalContent=addModal("small"),modalHeader=document.createElement("h2"),modalExplanation=document.createElement("h3");modalHeader.innerHTML="Site Not Supported",modalContent.appendChild(modalHeader),modalExplanation.innerHTML="<p>Sorry, I can't save to spotify from "+window.location.hostname+".</p>"+"<p>Try adding a song from Songza, Pandora, or Turntable.fm.</p>",modalContent.appendChild(modalExplanation)},showError:function(event){var modalContent=addModal("small"),modalHeader=document.createElement("h2"),modalExplanation=document.createElement("h3");modalHeader.innerHTML="Can't connect to Spotify",modalContent.appendChild(modalHeader),modalExplanation.innerHTML="<p>Sorry, I can't connect to Spotify right now.</p><p>Try again with the next song you like.</p>"+event.target.status,modalContent.appendChild(modalExplanation)},pauseSourceSiteMusic:function(){sourceSiteData.currentlyPlaying&&sourceSiteData.pauseButton.click()},openInSpotify:function(track){this.pauseSourceSiteMusic(),window.location=track.href}},closeModal=function(){document.body.removeChild(document.getElementById("add-to-spotify-overlay")),document.body.removeChild(document.getElementById("add-to-spotify-modal")),document.head.removeChild(document.getElementById("add-to-spotify-stylesheet")),document.body.style.overflow="auto",sourceSiteData.htmlEl.style.overflow="auto",resumeSourceSiteMusic()},addModal=function(type){var styleSheetLink=document.createElement("link");styleSheetLink.type="text/css",styleSheetLink.rel="stylesheet",styleSheetLink.id="add-to-spotify-stylesheet",styleSheetLink.href="http://d39ywk3d3wha95.cloudfront.net/save-to-spotify.css",sourceSiteData.headEl.appendChild(styleSheetLink);var firstBodyEl=document.body.firstChild,modal=document.createElement("div");modal.id="add-to-spotify-modal",modal.className="add-to-spotify-modal "+type;var closeBox=document.createElement("div");closeBox.id="close-spotify-modal",closeBox.className="close-modal",closeBox.innerHTML="&times;",modal.appendChild(closeBox);var modalContent=document.createElement("div");modalContent.id="add-to-spotify-modal-content",modalContent.className="modal-content",modal.appendChild(modalContent),document.body.insertBefore(modal,firstBodyEl),bindEvent(closeBox,"click",closeModal);var overlay=document.createElement("div");return overlay.id="add-to-spotify-overlay",overlay.className="add-to-spotify-overlay",overlay.style.height=parseInt(window.screen.height+20,10)+"px",document.body.style.overflow="hidden",sourceSiteData.htmlEl.style.overflow="hidden",document.body.insertBefore(overlay,modal),modalContent},bindEvent=function(element,event,thisFunction){element.addEventListener?element.addEventListener(event,thisFunction):element.attachEvent(event,thisFunction)},resumeSourceSiteMusic=function(){sourceSiteData.currentlyPlaying&&sourceSiteData.pauseButton.click()};exports.render=render}(typeof exports=="undefined"?this:modalExplanation),function(exports){var sourceSiteData={htmlEl:document.getElementsByTagName("html")[0],headEl:document.getElementsByTagName("head")[0]};switch(window.location.hostname){case"songza.com":var artist=document.getElementsByClassName("szi-artist")[0].innerHTML,track=document.getElementsByClassName("szi-song")[0].innerHTML;sourceSiteData.pauseButton=document.getElementsByClassName("szi-pause")[0],sourceSiteData.currentlyPlaying=document.getElementsByClassName("szi-player-state-play").length>0,displayResults(track,artist);break;default:render.showUnsupportedSiteMessage()}var displayResults=function(track,artist){try{spotifyQuerier.getTracks(track,artist,function(tracks){displayTracksOrArtists(tracks,artist)})}catch(e){render.showError(e)}},displayTracksOrArtists=function(tracks,artist){tracks.length===0?spotifyQuerier.getArtists(artist,displayArtists):tracks.length===1?render.openInSpotify(tracks[0]):render.showTrackOptions(tracks)},displayArtists=function(artists){artists.length===0?render.showNotFoundMessage():render.showArtistOptions(artists)};exports.sourceSiteData=sourceSiteData}(typeof exports=="undefined"?this:exports),function(){Array.prototype.map===undefined&&(Array.prototype.map=function(thisFunction){var result=[];for(var i=0;i<this.length;i++)result.push(thisFunction(this[i]));return result}),Array.prototype.filter===undefined&&(Array.prototype.filter=function(thisFunction){var result=[];for(var i=0;i<this.length;i++)thisFunction(this[i],i,this)&&result.push(this);return result})}();