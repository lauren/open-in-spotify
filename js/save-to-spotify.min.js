(function(exports){var render={showTrackOptions:function(tracks,currentlyPlaying,pauseButton){var modalContent=addModal("large",currentlyPlaying,pauseButton),modalHeader=document.createElement("h2"),trackList=document.createElement("ul");modalHeader.innerHTML="Matching Tracks on Spotify",modalContent.appendChild(modalHeader),tracks.map(function(track){var trackItemEl=document.createElement("li"),firstArtist=track.artists[0];trackItemEl.innerHTML="<a href='"+track.href+"'>"+track.name+"</a> by <a href='"+firstArtist.href+"'>"+firstArtist.name+"</a> from the album "+"<em><a href='"+track.album.href+"'></em>"+track.album.name+"</a>.",trackList.appendChild(trackItemEl)}),modalContent.appendChild(trackList),toggleSourceSiteMusic(currentlyPlaying,pauseButton)},showArtistOptions:function(artists){var modalContent=addModal("large"),modalHeader=document.createElement("h2"),modalCaveat=document.createElement("h3"),artistList=document.createElement("ul");modalCaveat.innerHTML="<p>Sorry! I couldn't find the exact track you're listening to on Spotify.</p>",modalContent.appendChild(modalCaveat),modalHeader.innerHTML="Matching Artists on Spotify",modalContent.appendChild(modalHeader),artists.map(function(artist){var artistItemEl=document.createElement("li");artistItemEl.innerHTML="<a href='"+artist.href+"'>"+artist.name+"</a>",artistList.appendChild(artistItemEl)}),modalContent.appendChild(artistList)},showNotFoundMessage:function(track,artist){var modalContent=addModal("small"),modalHeader=document.createElement("h2"),modalExplanation=document.createElement("h3");modalHeader.innerHTML="Not Found",modalContent.appendChild(modalHeader),modalExplanation.innerHTML="<p>Sorry, I couldn't find the track '"+track+"' or the artist "+artist+" on Spotify.</p><p>Try again with the next song you like.</p>",modalContent.appendChild(modalExplanation)},showUnsupportedSiteMessage:function(){var modalContent=addModal("small"),modalHeader=document.createElement("h2"),modalExplanation=document.createElement("h3");modalHeader.innerHTML="Site Not Supported",modalContent.appendChild(modalHeader),modalExplanation.innerHTML="<p>Sorry, I can't open songs from "+window.location.hostname+" in Spotify.</p>"+"<p>Try adding a song from <a href='http://songza.com'>Songza</a> or "+"<a href='http://turntable.fm'>Turntable.fm</a>.</p>",modalContent.appendChild(modalExplanation)},showWrongPageMessage:function(site){var modalContent=addModal("small"),modalHeader=document.createElement("h2"),modalExplanation=document.createElement("h3"),findPlaylistsAt=function(){return site==="Songza"?"Go to the <a href='http://songza.com'>Music Concierge</a> and select a station. ":site==="Pandora"?"Go to the <a href='http://pandora.com'>homepage</a> and search for an artist to create a radio station.":site==="turntable.fm"?"Go to the <a href='http://turntable.fm'>homepage</a> and find a room to join.":"Go "};modalHeader.innerHTML="No Songs Detected",modalContent.appendChild(modalHeader),modalExplanation.innerHTML="<p>You're almost there!</p><p>"+findPlaylistsAt()+"Then you'll be able to open songs from "+site+" in Spotify.",modalContent.appendChild(modalExplanation)},showError:function(event){var modalContent=addModal("small"),modalHeader=document.createElement("h2"),modalExplanation=document.createElement("h3");modalHeader.innerHTML="Can't connect to Spotify",modalContent.appendChild(modalHeader),modalExplanation.innerHTML="<p>Sorry, I can't connect to Spotify right now.</p><p>Try again with the next song you like.</p>"+event.target.status,modalContent.appendChild(modalExplanation)},openInSpotify:function(track,currentlyPlaying,pauseButton){toggleSourceSiteMusic(currentlyPlaying,pauseButton),window.location=track.href}},closeModal=function(currentlyPlaying,pauseButton){document.body.removeChild(document.getElementById("add-to-spotify-overlay")),document.body.removeChild(document.getElementById("add-to-spotify-modal")),document.head.removeChild(document.getElementById("add-to-spotify-stylesheet")),document.body.style.overflow="auto",document.getElementsByTagName("html")[0].style.overflow="auto",toggleSourceSiteMusic(currentlyPlaying,pauseButton)},addModal=function(type,currentlyPlaying,pauseButton){var styleSheetLink=document.createElement("link");styleSheetLink.type="text/css",styleSheetLink.rel="stylesheet",styleSheetLink.id="add-to-spotify-stylesheet",styleSheetLink.href="http://d39ywk3d3wha95.cloudfront.net/save-to-spotify.css",document.head.appendChild(styleSheetLink);var firstBodyEl=document.body.firstChild,modal=document.createElement("div");modal.id="add-to-spotify-modal",modal.className="add-to-spotify-modal "+type;var closeBox=document.createElement("div");closeBox.id="close-spotify-modal",closeBox.className="close-modal",closeBox.innerHTML="&times;",modal.appendChild(closeBox);var modalContent=document.createElement("div");modalContent.id="add-to-spotify-modal-content",modalContent.className="modal-content",modal.appendChild(modalContent),document.body.insertBefore(modal,firstBodyEl),bindEvent(closeBox,"click",function(){closeModal(currentlyPlaying,pauseButton)});var overlay=document.createElement("div");return overlay.id="add-to-spotify-overlay",overlay.className="add-to-spotify-overlay",overlay.style.height=parseInt(window.screen.height+20,10)+"px",document.body.style.overflow="hidden",document.getElementsByTagName("html")[0].style.overflow="hidden",document.body.insertBefore(overlay,modal),modalContent},bindEvent=function(element,event,thisFunction){element.addEventListener?element.addEventListener(event,thisFunction):element.attachEvent(event,thisFunction)},toggleSourceSiteMusic=function(currentlyPlaying,pauseButton){currentlyPlaying&&pauseButton.click()};exports.render=render})(typeof exports=="undefined"?this:modalExplanation),function(exports){exports.selectors={Songza:function(){this.artist=document.getElementsByClassName("szi-artist")[0].innerHTML,this.track=document.getElementsByClassName("szi-song")[0].innerHTML,this.pauseButton=document.getElementsByClassName("szi-pause")[0],this.currentlyPlaying=document.getElementsByClassName("szi-player-state-play").length>0},Pandora:function(){this.track=document.getElementsByClassName("songTitle")[0].innerHTML,this.artist=document.getElementsByClassName("artistSummary")[0].innerHTML,this.album=document.getElementsByClassName("albumTitle")[0].innerHTML,this.pauseButton=document.getElementsByClassName("pauseButton")[0],this.currentlyPlaying=this.pauseButton.style.display==="block"},TurntableFM:function(){this.track=document.getElementsByClassName("songboard-title")[0].innerHTML,this.artist=document.getElementsByClassName("songboard-artist")[0].innerHTML,this.currentlyPlaying=!1}}}(typeof exports=="undefined"?this:exports),function(exports){var errorCallback=function(error){throw"Can't connect to Spotify."},sanitizeTrackAndAlbumNames=function(tracks){var newTracks=tracks.map(function(thisTrack){return thisTrack.name=thisTrack.name.replace(/[\.,-\/#!\$%\^&\*;:{}=\-_`~\(\)]/g,""),thisTrack.name=thisTrack.name.replace(/\s{2,}/g," "),thisTrack.album.name=thisTrack.album.name.replace(/[\.,-\/#!\$%\^&\*;:{}=\-_`~\(\)]/g,""),thisTrack.album.name=thisTrack.album.name.replace(/\s{2,}/g," "),thisTrack.artists=thisTrack.artists.map(function(artist){return artist.name=artist.name.replace(/[\.,-\/#!\$%\^&\*;:{}=\-_`~\(\)]/g,""),artist.name=artist.name.replace(/\s{2,}/g," "),artist}),thisTrack});return newTracks},validateTrackArtist=function(tracks,artist){return artist=artist.replace(/[\.,-\/#!\$%\^&\*;:{}=\-_`~\(\)]/g,""),artist=artist.replace(/\s{2,}/g," "),tracks.filter(function(thisTrack){return indexOfArtistName(thisTrack.artists,artist)>-1})},indexOfArtistName=function(array,artistName){for(var i=0;i<array.length;i++)if(array[i].name.toLowerCase()===artistName.toLowerCase())return i;return-1},dedupeTracks=function(tracks){tracks=tracks.reverse();var dedupedTracks=tracks.filter(function(thisTrack,index){var otherTracks=tracks.slice(index+1,tracks.length);return!findTrackInArray(thisTrack,otherTracks)});return dedupedTracks.reverse()},findTrackInArray=function(track,otherTracks){for(var i=0;i<otherTracks.length;i++)if(track.name===otherTracks[i].name&&track.album.name===otherTracks[i].album.name)return!0;return!1},spotifyQuerier={ajaxRequest:function(url,successCallback,errorCallback){var xhr=new XMLHttpRequest;xhr.onload=successCallback,xhr.onerror=errorCallback,xhr.open("get",url),xhr.send()},getTracks:function(track,artist,callback){var spotifyUrl="http://ws.spotify.com/search/1/track.json?q="+track.replace(/\s/g,"%20");this.ajaxRequest(spotifyUrl,function(){var response=JSON.parse(this.responseText),sanitizedTracks=sanitizeTrackAndAlbumNames(response.tracks),validTracks=validateTrackArtist(sanitizedTracks,artist),tracks=dedupeTracks(validTracks);callback(tracks)},errorCallback)},getArtists:function(artist,callback){var spotifyUrl="http://ws.spotify.com/search/1/artist.json?q="+artist.replace(/\s/g,"%20");this.ajaxRequest(spotifyUrl,function(){var response=JSON.parse(this.responseText),artists=response.artists;callback(artists)},errorCallback)}};exports.spotifyQuerier=spotifyQuerier}(typeof exports=="undefined"?this:exports),function(exports){var SaveToSpotify=function(siteInfo){this.siteInfo=siteInfo};SaveToSpotify.prototype.displayResults=function(){var self=this;try{spotifyQuerier.getTracks(this.siteInfo.track,this.siteInfo.artist,function(tracks){self.displayTracksOrArtists.call(self,tracks)})}catch(e){render.showError(e,self.siteInfo.currentlyPlaying,self.siteInfo.pauseButton)}},SaveToSpotify.prototype.displayTracksOrArtists=function(tracks){var self=this;tracks.length===0?spotifyQuerier.getArtists(this.siteInfo.artist,function(artists){self.displayArtists.call(self,artists)}):tracks.length===1?render.openInSpotify(tracks[0],this.siteInfo.currentlyPlaying,this.siteInfo.pauseButton):render.showTrackOptions(tracks,this.siteInfo.currentlyPlaying,this.siteInfo.pauseButton)},SaveToSpotify.prototype.displayArtists=function(artists){artists.length===0?render.showNotFoundMessage(this.siteInfo.track,this.siteInfo.artist):render.showArtistOptions(artists)};switch(window.location.hostname){case"songza.com":case"www.songza.com":try{var siteInfo=new selectors.Songza}catch(e){render.showWrongPageMessage("Songza")}(new SaveToSpotify(siteInfo)).displayResults();break;case"turntable.fm":case"www.turntable.fm":try{var siteInfo=new selectors.TurntableFM}catch(e){render.showWrongPageMessage("turntable.fm")}(new SaveToSpotify(siteInfo)).displayResults();break;default:render.showUnsupportedSiteMessage()}}(typeof exports=="undefined"?this:exports),function(exports){var customMap=function(thisFunction){var result=[];for(var i=0;i<this.length;i++)result.push(thisFunction(this[i]));return result},customFilter=function(thisFunction){var result=[];for(var i=0;i<this.length;i++)thisFunction(this[i],i,this)&&result.push(this);return result};Array.prototype.map===undefined&&(Array.prototype.map=customMap),Array.prototype.filter===undefined&&(Array.prototype.filter=customFilter),exports.shims={customFilter:customFilter,customMap:customMap}}(typeof exports=="undefined"?this:exports);