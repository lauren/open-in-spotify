// this keeps a queue of opened file descriptors, and will make
// fs operations wait until some have closed before trying to open more.
function OpenReq(path,flags,mode,cb){this.path=path,this.flags=flags,this.mode=mode,this.cb=cb}function noop(){}function gracefulOpen(path,flags,mode,cb){typeof mode=="function"&&(cb=mode,mode=null),typeof cb!="function"&&(cb=noop);if(fs._curOpen>=fs.MAX_OPEN){queue.push(new OpenReq(path,flags,mode,cb)),setTimeout(flush);return}open(path,flags,mode,function(er,fd){if(er&&er.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN)return fs.MAX_OPEN=fs._curOpen-1,fs.open(path,flags,mode,cb);cb(er,fd)})}function open(path,flags,mode,cb){cb=cb||noop,fs._curOpen++,fs._originalFs.open.call(fs,path,flags,mode,function(er,fd){er&&onclose(),cb(er,fd)})}function onclose(){fs._curOpen--,flush()}function flush(){while(fs._curOpen<fs.MAX_OPEN){var req=queue.shift();if(!req)return;switch(req.constructor.name){case"OpenReq":open(req.path,req.flags||"r",req.mode||511,req.cb);break;case"ReaddirReq":readdir(req.path,req.cb);break;case"ReadFileReq":readFile(req.path,req.options,req.cb);break;case"WriteFileReq":writeFile(req.path,req.data,req.options,req.cb);break;default:throw new Error("Unknown req type: "+req.constructor.name)}}}function gracefulReaddir(path,cb){if(fs._curOpen>=fs.MAX_OPEN){queue.push(new ReaddirReq(path,cb)),setTimeout(flush);return}readdir(path,function(er,files){if(er&&er.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN)return fs.MAX_OPEN=fs._curOpen-1,fs.readdir(path,cb);cb(er,files)})}function readdir(path,cb){cb=cb||noop,fs._curOpen++,fs._originalFs.readdir.call(fs,path,function(er,files){onclose(),cb(er,files)})}function ReaddirReq(path,cb){this.path=path,this.cb=cb}function gracefulReadFile(path,options,cb){typeof options=="function"&&(cb=options,options=null),typeof cb!="function"&&(cb=noop);if(fs._curOpen>=fs.MAX_OPEN){queue.push(new ReadFileReq(path,options,cb)),setTimeout(flush);return}readFile(path,options,function(er,data){if(er&&er.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN)return fs.MAX_OPEN=fs._curOpen-1,fs.readFile(path,options,cb);cb(er,data)})}function readFile(path,options,cb){cb=cb||noop,fs._curOpen++,fs._originalFs.readFile.call(fs,path,options,function(er,data){onclose(),cb(er,data)})}function ReadFileReq(path,options,cb){this.path=path,this.options=options,this.cb=cb}function gracefulWriteFile(path,data,options,cb){typeof options=="function"&&(cb=options,options=null),typeof cb!="function"&&(cb=noop);if(fs._curOpen>=fs.MAX_OPEN){queue.push(new WriteFileReq(path,data,options,cb)),setTimeout(flush);return}writeFile(path,data,options,function(er){if(er&&er.code==="EMFILE"&&fs._curOpen>fs.MIN_MAX_OPEN)return fs.MAX_OPEN=fs._curOpen-1,fs.writeFile(path,data,options,cb);cb(er)})}function writeFile(path,data,options,cb){cb=cb||noop,fs._curOpen++,fs._originalFs.writeFile.call(fs,path,data,options,function(er){onclose(),cb(er)})}function WriteFileReq(path,data,options,cb){this.path=path,this.data=data,this.options=options,this.cb=cb}function chownFix(orig){return orig?function(target,uid,gid,cb){return orig.call(fs,target,uid,gid,function(er,res){chownErOk(er)&&(er=null),cb(er,res)})}:orig}function chownFixSync(orig){return orig?function(target,uid,gid){try{return orig.call(fs,target,uid,gid)}catch(er){if(!chownErOk(er))throw er}}:orig}function chownErOk(er){if(!er||(!process.getuid||process.getuid()!==0)&&(er.code==="EINVAL"||er.code==="EPERM"))return!0}var fs=exports=module.exports={};fs._originalFs=require("fs"),Object.getOwnPropertyNames(fs._originalFs).forEach(function(prop){var desc=Object.getOwnPropertyDescriptor(fs._originalFs,prop);Object.defineProperty(fs,prop,desc)});var queue=[],constants=require("constants");fs._curOpen=0,fs.MIN_MAX_OPEN=64,fs.MAX_OPEN=1024,fs.open=gracefulOpen,fs.openSync=function(path,flags,mode){var ret;return ret=fs._originalFs.openSync.call(fs,path,flags,mode),fs._curOpen++,ret},fs.close=function(fd,cb){cb=cb||noop,fs._originalFs.close.call(fs,fd,function(er){onclose(),cb(er)})},fs.closeSync=function(fd){try{return fs._originalFs.closeSync.call(fs,fd)}finally{onclose()}},fs.readdir=gracefulReaddir,fs.readFile=gracefulReadFile,fs.writeFile=gracefulWriteFile;var constants=require("constants");constants.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&(fs.lchmod=function(path,mode,callback){callback=callback||noop,fs.open(path,constants.O_WRONLY|constants.O_SYMLINK,mode,function(err,fd){if(err){callback(err);return}fs.fchmod(fd,mode,function(err){fs.close(fd,function(err2){callback(err||err2)})})})},fs.lchmodSync=function(path,mode){var fd=fs.openSync(path,constants.O_WRONLY|constants.O_SYMLINK,mode),err,err2;try{var ret=fs.fchmodSync(fd,mode)}catch(er){err=er}try{fs.closeSync(fd)}catch(er){err2=er}if(err||err2)throw err||err2;return ret}),fs.lutimes||(constants.hasOwnProperty("O_SYMLINK")?(fs.lutimes=function(path,at,mt,cb){fs.open(path,constants.O_SYMLINK,function(er,fd){cb=cb||noop;if(er)return cb(er);fs.futimes(fd,at,mt,function(er){fs.close(fd,function(er2){return cb(er||er2)})})})},fs.lutimesSync=function(path,at,mt){var fd=fs.openSync(path,constants.O_SYMLINK),err,err2,ret;try{var ret=fs.futimesSync(fd,at,mt)}catch(er){err=er}try{fs.closeSync(fd)}catch(er){err2=er}if(err||err2)throw err||err2;return ret}):fs.utimensat&&constants.hasOwnProperty("AT_SYMLINK_NOFOLLOW")?(fs.lutimes=function(path,at,mt,cb){fs.utimensat(path,at,mt,constants.AT_SYMLINK_NOFOLLOW,cb)},fs.lutimesSync=function(path,at,mt){return fs.utimensatSync(path,at,mt,constants.AT_SYMLINK_NOFOLLOW)}):(fs.lutimes=function(_a,_b,_c,cb){process.nextTick(cb)},fs.lutimesSync=function(){})),fs.chown=chownFix(fs.chown),fs.fchown=chownFix(fs.fchown),fs.lchown=chownFix(fs.lchown),fs.chownSync=chownFixSync(fs.chownSync),fs.fchownSync=chownFixSync(fs.fchownSync),fs.lchownSync=chownFixSync(fs.lchownSync),fs.lchmod||(fs.lchmod=function(path,mode,cb){process.nextTick(cb)},fs.lchmodSync=function(){}),fs.lchown||(fs.lchown=function(path,uid,gid,cb){process.nextTick(cb)},fs.lchownSync=function(){});if(process.platform==="win32"){var rename_=fs.rename;fs.rename=function rename(from,to,cb){var start=Date.now();rename_(from,to,function CB(er){if(er&&(er.code==="EACCES"||er.code==="EPERM")&&Date.now()-start<1e3)return rename_(from,to,CB);cb(er)})}}var read=fs.read;fs.read=function(fd,buffer,offset,length,position,callback_){var callback;if(callback_&&typeof callback_=="function"){var eagCounter=0;callback=function(er,_,__){if(er&&er.code==="EAGAIN"&&eagCounter<10)return eagCounter++,read.call(fs,fd,buffer,offset,length,position,callback);callback_.apply(this,arguments)}}return read.call(fs,fd,buffer,offset,length,position,callback)};var readSync=fs.readSync;fs.readSync=function(fd,buffer,offset,length,position){var eagCounter=0;for(;;)try{return readSync.call(fs,fd,buffer,offset,length,position)}catch(er){if(er.code==="EAGAIN"&&eagCounter<10){eagCounter++;continue}throw er}};