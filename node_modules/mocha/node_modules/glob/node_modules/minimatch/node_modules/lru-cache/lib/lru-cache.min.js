(function(){function hOP(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)}function naiveLength(){return 1}function LRUCache(options){function get(key,doUse){var hit=cache[key];return hit&&(maxAge&&Date.now()-hit.now>maxAge?(del(hit),allowStale||(hit=undefined)):doUse&&use(hit),hit&&(hit=hit.value)),hit}function use(hit){shiftLU(hit),hit.lu=mru++,lruList[hit.lu]=hit}function trim(){while(lru<mru&&length>max)del(lruList[lru])}function shiftLU(hit){delete lruList[hit.lu];while(lru<mru&&!lruList[lru])lru++}function del(hit){hit&&(dispose&&dispose(hit.key,hit.value),length-=hit.length,itemCount--,delete cache[hit.key],shiftLU(hit))}if(!(this instanceof LRUCache))return new LRUCache(options);var max;typeof options=="number"&&(max=options,options={max:max}),options||(options={}),max=options.max;var lengthCalculator=options.length||naiveLength;typeof lengthCalculator!="function"&&(lengthCalculator=naiveLength);if(!max||typeof max!="number"||max<=0)max=Infinity;var allowStale=options.stale||!1,maxAge=options.maxAge||null,dispose=options.dispose,cache=Object.create(null),lruList=Object.create(null),mru=0,lru=0,length=0,itemCount=0;Object.defineProperty(this,"max",{set:function(mL){if(!mL||typeof mL!="number"||mL<=0)mL=Infinity;max=mL,length>max&&trim()},get:function(){return max},enumerable:!0}),Object.defineProperty(this,"lengthCalculator",{set:function(lC){if(typeof lC!="function"){lengthCalculator=naiveLength,length=itemCount;for(var key in cache)cache[key].length=1}else{lengthCalculator=lC,length=0;for(var key in cache)cache[key].length=lengthCalculator(cache[key].value),length+=cache[key].length}length>max&&trim()},get:function(){return lengthCalculator},enumerable:!0}),Object.defineProperty(this,"length",{get:function(){return length},enumerable:!0}),Object.defineProperty(this,"itemCount",{get:function(){return itemCount},enumerable:!0}),this.forEach=function(fn,thisp){thisp=thisp||this;var i=0;for(var k=mru-1;k>=0&&i<itemCount;k--)if(lruList[k]){i++;var hit=lruList[k];fn.call(thisp,hit.value,hit.key,this)}},this.keys=function(){var keys=new Array(itemCount),i=0;for(var k=mru-1;k>=0&&i<itemCount;k--)if(lruList[k]){var hit=lruList[k];keys[i++]=hit.key}return keys},this.values=function(){var values=new Array(itemCount),i=0;for(var k=mru-1;k>=0&&i<itemCount;k--)if(lruList[k]){var hit=lruList[k];values[i++]=hit.value}return values},this.reset=function(){if(dispose)for(var k in cache)dispose(k,cache[k].value);cache={},lruList={},lru=0,mru=0,length=0,itemCount=0},this.dump=function(){return cache},this.dumpLru=function(){return lruList},this.set=function(key,value){if(hOP(cache,key))return dispose&&dispose(key,cache[key].value),maxAge&&(cache[key].now=Date.now()),cache[key].value=value,this.get(key),!0;var len=lengthCalculator(value),age=maxAge?Date.now():0,hit=new Entry(key,value,mru++,len,age);return hit.length>max?(dispose&&dispose(key,value),!1):(length+=hit.length,lruList[hit.lu]=cache[key]=hit,itemCount++,length>max&&trim(),!0)},this.has=function(key){if(!hOP(cache,key))return!1;var hit=cache[key];return maxAge&&Date.now()-hit.now>maxAge?!1:!0},this.get=function(key){return get(key,!0)},this.peek=function(key){return get(key,!1)},this.del=function(key){del(cache[key])}}function Entry(key,value,mru,len,age){this.key=key,this.value=value,this.lu=mru,this.length=len,this.now=age}typeof module=="object"&&module.exports?module.exports=LRUCache:this.LRUCache=LRUCache})();