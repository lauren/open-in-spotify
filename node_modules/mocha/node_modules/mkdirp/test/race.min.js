var mkdirp=require("../").mkdirp,path=require("path"),fs=require("fs"),test=require("tap").test;test("race",function(t){function mk(file,cb){mkdirp(file,493,function(err){err?t.fail(err):path.exists(file,function(ex){ex?fs.stat(file,function(err,stat){err?t.fail(err):(t.equal(stat.mode&511,493),t.ok(stat.isDirectory(),"target not a directory"),cb&&cb())}):t.fail("file not created")})})}t.plan(4);var ps=["","tmp"];for(var i=0;i<25;i++){var dir=Math.floor(Math.random()*Math.pow(16,4)).toString(16);ps.push(dir)}var file=ps.join("/"),res=2;mk(file,function(){--res===0&&t.end()}),mk(file,function(){--res===0&&t.end()})});